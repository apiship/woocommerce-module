!function(t){"use strict";if("undefined"!=typeof WPApiShip&&"undefined"!=typeof WPApiShipMap&&"undefined"!=typeof ymaps){var e={parseBool:function(t){return!/^(false|0)$/i.test(t)&&!!t},listPointsOut:null,tariffList:null,pointsMode:1,methodId:null,map:null,toCity:null,providerKey:null,requestKeyEnabled:!1,isMapExists:function(){return null!==e.map&&"object"==typeof e.map},getToCity:function(){return e.toCity},setToCity:function(){var a=!1;1==t(WPApiShip.getParam("cartBlockSelector")).length?a=t('input[name="calc_shipping_city"]').val():a=t('input[name="ship_to_different_address"]').prop("checked")?t('input[name="shipping_city"]').val():t('input[name="billing_city"]').val();e.toCity=a.trim()},getCod:function(){return"cod"==e.getPaymentMethod()?"1":"0"},getPaymentMethod:function(){return t('input[name="payment_method"]:checked').val()},getProviderKey:function(){return e.providerKey},getTariffPointsList:function(){return e.tariffPointsList},setProviderKey:function(a){if(!1===a||"string"==typeof a)e.providerKey=a;else if(0==e.requestKeyEnabled){var i=t(e.getParam("checkedShippingMethodSelector")).val(),o=t('.wpapiship-delivery-to-point[data-value="'+i+'"]');if(1==o.length){var n=o.data("delivery-type");e.isDeliveryToPointOut(n)?e.providerKey=o.data("provider-key"):e.providerKey=!1}}},setTariffData:function(){var a=t(e.getParam("checkedShippingMethodSelector")).val(),i=t('.wpapiship-delivery-to-point[data-value="'+a+'"]');if(1==i.length){var o=i.data("delivery-type");e.isDeliveryToPointOut(o)?(e.tariffPointsList=i.data("points-list"),e.tariffList=i.data("tariff-list")):(e.tariffPointsList=!1,e.tariffList=!1),e.pointsMode=i.data("display-mode"),e.methodId=a}},getListPointsOut:function(){return e.listPointsOut},getPointOut:function(t){if(!(t=t||!1))return!1;var a=!1;return e.getListPointsOut().rows.map(((e,i)=>{1*e.id==1*t&&(a=e)})),a},getAjaxUrl:function(){return WPApiShipMap.ajaxurl},getProcessAjax:function(){return WPApiShipMap.process_ajax},getMap:function(){return e.map},getParam:function(t){return null===(t=t||null)?WPApiShipMap.data:void 0!==WPApiShipMap[t]?WPApiShipMap[t]:void 0!==WPApiShipMap.data[t]?WPApiShipMap.data[t]:null},canStart:function(){return!!WPApiShip.isStart()},getBalloonContent:function(t){var a='<div class="point-out-balloon-content">';return a+='<div class="provider-key">Служба доставки: '+t.providerName,a+="</div>",a+='<div class="point-out-address">'+t.streetType+"."+t.street+", д."+t.house,"2"==t.availableOperation&&(a+=" ("+WPApiShip.__("postamat")+")"),a+="</div>",a+="<br />",1!=e.pointsMode&&(a+='<div style="margin-bottom: 10px;">',a+="<div>Выбор тарифа</div>",a+='<select class="wpapiship-select-map-tariff">',e.tariffList.forEach((e=>{let i=e.daysMin,o=!1;e.pointIds.forEach((e=>{e==t.id&&(o=!0)})),!1!==o&&(e.daysMin!=e.daysMax&&(i+="-"+e.daysMax),a+='<option data-method-id="'+e.methodId+'" data-provider-key="'+e.providerKey+'" value="'+e.tariffId+'">',a+=e.providerName+", ",a+=e.tariffName+", ",a+=i+" дн., ",a+=e.deliveryCost?.toFixed(2)+" руб.",a+="</option>")})),a+="</select>",a+="</div>"),a+='<div class="description">',a+=t.description,a+="</div>",a+="<br />",a+='<div class="point-out-select-wrapper">',a+='<a href="#" data-id="'+t.id+'" data-address="'+t.address+'"',a+=' onclick="return false;" class="point-out-select button button-secondary">'+WPApiShip.__("Select"),a+="</a>",a+="</div>",a+="</div>"},getCaption:function(t){var e=t.street+", д."+t.house;return"2"==t.availableOperation&&(e+="("+WPApiShip.__("postamat")+")"),e},placePointOutToMap:function(t){e.map.geoObjects.add(new ymaps.Placemark([t.lat,t.lng],{balloonContent:e.getBalloonContent(t)},{preset:"islands#icon",iconColor:"#0000ff"}))},newMap:function(t){e.map=new ymaps.Map("wpapiship-checkout-ymap",{center:[t.lat,t.lng],zoom:12,controls:[]});let a=new ymaps.control.Button(WPApiShip.__("closeButtonCaption"));a.events.add("click",(function(t){e.closeMap()})),e.map.controls.add(a,{float:"right"}),e.map.controls.add(new ymaps.control.ZoomControl({options:{size:"small"}}))},mapInit:function(){var t=e.getListPointsOut();null!==t&&t.rows.map((function(t){null===e.map&&e.newMap(t),e.placePointOutToMap(t)}))},getMapCenter:function(a){var i=t(e.getParam("pointOutAddressSelector")).data("lat"),o=t(e.getParam("pointOutAddressSelector")).data("lng"),n={};return n.lat=1*i,void 0!==i&&""!==i||(n.lat=a.lat),n.lng=1*o,void 0!==o&&""!==o||(n.lng=a.lng),n},mapStart:function(){var t=e.getToCity();e.listPointsOut=null;var a={action:"getListPointsOut",city:t,tariffPointsList:e.getTariffPointsList(),availableOperation:"[2,3]",cod:e.getCod(),doneCallback:t=>{if(void 0!==t&&t.success){void 0!==t.data.error_message&&console.log(t.data.error_message);try{e.listPointsOut=JSON.parse(t.data.response.body)}catch(t){return void console.log("getListPointsOut:: parsing error.")}e.isMapExists()?e.getListPointsOut().rows.map((function(t,a){if(0===a){e.map.geoObjects.removeAll();var i=e.getMapCenter(t);e.map.setCenter([i.lat,i.lng])}e.placePointOutToMap(t)})):ymaps.ready(e.mapInit)}}};(3!=e.pointsMode||3==e.pointsMode&&1==e.requestKeyEnabled)&&(a.providerKey=e.getProviderKey()),e.ajax(a)},ajax:function(a){return t.ajax({beforeSend:function(){"function"==typeof e.ajaxBeforeSend&&e.ajaxBeforeSend(a)},type:"POST",url:e.getAjaxUrl(),data:{action:e.getProcessAjax(),request:a},dataType:"json"}).done((function(t){"function"==typeof a.doneCallback&&a.doneCallback(t)})).fail((function(t,e){"function"==typeof a.failCallback&&a.failCallback(t,e)})).always((function(t,e){"function"==typeof a.alwaysCallback&&a.alwaysCallback(t,e)}))},openMap:function(){e.mapStart(),t("body").addClass(e.getParam("checkoutBodyOverlay")),t(e.getParam("checkoutMapWrapper")).addClass("open")},closeMap:function(){t("body").removeClass(e.getParam("checkoutBodyOverlay")),t(e.getParam("checkoutMapWrapper")).removeClass("open")},showPointOutFields:function(){t(WPApiShip.getParam("checkoutRowSelector")).removeClass("hidden"),0==t(e.getParam("checkedShippingMethodSelector")).parent().find(".wpapiship-map-start").data("point-out-id")?(t(e.getParam("pointOutFieldSelector")).val(""),t(e.getParam("pointOutAddressSelector")).val("").data("id","").data("lat","").data("lng","")):e.initSelectedPoint()},hidePointOutFields:function(){t(WPApiShip.getParam("checkoutRowSelector")).addClass("hidden"),t(e.getParam("pointOutFieldSelector")).val(""),t(e.getParam("pointOutAddressSelector")).val("").data("id","").data("lat","").data("lng","")},selectProviderCallback:function(){t(document).on("change",e.getParam("mapProviderSelect"),(function(a){e.reloadMap(t(this).val()),e.selectProviderCallback()}))},reloadMap:function(t=null){e.requestKeyEnabled=!1,null!=t&&"all-providers"!=t&&(e.providerKey=t,e.requestKeyEnabled=!0),e.setToCity(),e.setProviderKey(),e.setTariffData(),e.openMap()},attachListeners:function(){t(document).on("click",e.getParam("checkoutMapSelector"),(function(t){t.stopPropagation()})),t(document).on("click",e.getParam("checkoutBodyOverlaySelector"),(function(a){t(a.target).closest("#wpapiship_map_options").length||e.closeMap()})),e.selectProviderCallback(),t(document).on("click",e.getParam("pointOutSelectSelector"),(function(a){t(document).trigger("selectPointOut",[t(this)]);var i,o,n=t(this).data("id"),r=!1,d="";if(void 0!==n&&(r=e.getPointOut(n))){void 0===(i=r.lat)&&(i=""),void 0===(o=r.lng)&&(o=""),d=r.city+", "+r.streetType+"."+r.street+" "+r.house,t(e.getParam("pointOutAddressSelector")).data("id",n.toString()).data("lat",i.toString()).data("lng",o.toString()),t(e.getParam("pointOutAddressSelector")).val(d),t(e.getParam("checkedShippingMethodSelector")).parent().find(".pointAddress").text(d),t(e.getParam("checkedShippingMethodSelector")).parent().find(".pointName").text(r.name),t(e.getParam("checkedShippingMethodSelector")).parent().find(".wpapiship-map-start").text(" ("+WPApiShip.__("selectedPointButtonText")+")"),1!=e.pointsMode&&(e.tariffId=t(".wpapiship-select-map-tariff").val(),e.providerKey=t(".wpapiship-select-map-tariff option:selected").data("provider-key"),e.methodId=t(".wpapiship-select-map-tariff option:selected").data("method-id"));var p={action:"saveClientSelectedPoint",address:d,name:r.name,id:n,tariff_id:e.tariffId,method_id:e.methodId};e.ajax(p),t("body").trigger("update_checkout")}e.closeMap()})),t(document).on("click",e.getParam("shippingMethodSelector"),(function(a){if(1==t(this).attr("data-is-saved"))return void t(this).attr("data-is-saved",0);t(e.getParam("pointOutFieldSelector")).val("");var i=t(e.getParam("checkedShippingMethodSelector")).val(),o=!1,n=t('.wpapiship-delivery-to-point[data-value="'+i+'"]');1==n.length&&(o=n.data("delivery-type"),e.isDeliveryToPointOut(o)?e.showPointOutFields():e.hidePointOutFields());var r={action:"saveClientSelectedTariff",tariff_id:t(this).parent().find(".wpapiship-map-start").data("tariff-id"),method_id:i};e.ajax(r)})),t(document).on("click",e.getParam("mapStartSelector"),(function(a){t(this).parent().find("input.shipping_method").prop("checked",!0),e.setToCity(),e.setProviderKey(),e.setTariffData(),e.openMap()})),t(document).ready((function(){setInterval((function(){if(0!=t(".woocommerce .blockUI.blockOverlay").length){let a=setInterval((function(){0==t(".woocommerce .blockUI.blockOverlay").length&&(t("input.shipping_method").each((function(a){if("1"==t(this).parent().find(".wpapiship-delivery-to-point").data("tariff-selected")&&0==t(this).prop("checked"))return t(this).prop("checked",!0),void e.initSelectedPoint()})),clearInterval(a))}),1200)}}),1500)}))},initSelectedPoint:function(){var a=t(e.getParam("checkedShippingMethodSelector")).val(),i=t('.wpapiship-delivery-to-point[data-value="'+a+'"]');if(1==i.length&&"0"!=i.data("point-out-id")){var o=i.data("point-out-id"),n=i.data("point-out-address"),r={};void 0!==n&&(r.address=n),void 0!==o&&(r.id=o),t(e.getParam("pointOutFieldSelector")).val(JSON.stringify(r))}},isDeliveryToPointOut:function(a){var i=!1;return t.each(e.getParam("deliveryTypes"),(function(t,e){1*e==1*a&&"toPointOut"===t&&(i=!0)})),i},addButton:function(){setTimeout((()=>{var a='<p class="form-row form-row-wide '+WPApiShip.getParam("checkoutRow")+' hidden" id="wpapiship-point-out-address-wrapper">';a+='<label for="'+e.getParam("pointOutAddress")+'">Пункт выдачи заказа </label>',a+='<input type="text" id="'+e.getParam("pointOutAddress")+'" disabled="disabled" data-id="" data-lat="" data-lng="" />',t(a+="</p>").insertAfter(WPApiShip.getParam("pointOutFieldWrapperSelector"))}),1e3)},initialSet:function(){var a=t(WPApiShip.getParam("checkedShippingMethodSelector")).val(),i=t('.wpapiship-delivery-to-point[data-value="'+a+'"]');if(1==i.length){var o=i.data("delivery-type");e.isDeliveryToPointOut(o)&&setTimeout((()=>{e.setProviderKey(),e.setTariffData(),e.showPointOutFields()}),4500)}},start:function(){e.canStart()&&(e.addButton(),e.initialSet(),e.attachListeners(),e.initSelectedPoint())}};WPApiShipMap=t.extend({},WPApiShipMap,e),WPApiShipMap.start()}}(jQuery);