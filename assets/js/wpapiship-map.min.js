!function(t){"use strict";if("undefined"!=typeof WPApiShip&&"undefined"!=typeof WPApiShipMap&&"undefined"!=typeof ymaps){var e={parseBool:function(t){return!/^(false|0)$/i.test(t)&&!!t},listPointsOut:null,map:null,toCity:null,providerKey:null,isMapExists:function(){return null!==e.map&&"object"==typeof e.map},getToCity:function(){return e.toCity},setToCity:function(){var i=!1;1==t(WPApiShip.getParam("cartBlockSelector")).length?i=t('input[name="calc_shipping_city"]').val():i=t('input[name="ship_to_different_address"]').prop("checked")?t('input[name="shipping_city"]').val():t('input[name="billing_city"]').val();e.toCity=i.trim()},getCod:function(){return"cod"==e.getPaymentMethod()?"1":"0"},getPaymentMethod:function(){return t('input[name="payment_method"]:checked').val()},getProviderKey:function(){return e.providerKey},getTariffPointsList:function(){return e.tariffPointsList},setProviderKey:function(i){if(!1===i||"string"==typeof i)e.providerKey=i;else{var a=t(e.getParam("checkedShippingMethodSelector")).val(),n=t('.wpapiship-delivery-to-point[data-value="'+a+'"]');if(1==n.length){var o=n.data("delivery-type");e.isDeliveryToPointOut(o)?e.providerKey=n.data("provider-key"):e.providerKey=!1}}},setTariffPointsList:function(){var i=t(e.getParam("checkedShippingMethodSelector")).val(),a=t('.wpapiship-delivery-to-point[data-value="'+i+'"]');if(1==a.length){var n=a.data("delivery-type");e.isDeliveryToPointOut(n)?e.tariffPointsList=a.data("points-list"):e.tariffPointsList=!1}},getListPointsOut:function(){return e.listPointsOut},getPointOut:function(t){if(!(t=t||!1))return!1;var i=!1;return e.getListPointsOut().rows.map((e,a)=>{1*e.id==1*t&&(i=e)}),i},getAjaxUrl:function(){return WPApiShipMap.ajaxurl},getProcessAjax:function(){return WPApiShipMap.process_ajax},getMap:function(){return e.map},getParam:function(t){return null===(t=t||null)?WPApiShipMap.data:void 0!==WPApiShipMap[t]?WPApiShipMap[t]:void 0!==WPApiShipMap.data[t]?WPApiShipMap.data[t]:null},canStart:function(){return!!WPApiShip.isStart()},getBalloonContent:function(t){var e='<div class="point-out-balloon-content">';return e+='<div class="provider-key">Служба доставки: '+t.providerKey,e+="</div>",e+='<div class="point-out-address">'+t.streetType+"."+t.street+", д."+t.house,"2"==t.availableOperation&&(e+=" ("+WPApiShip.__("postamat")+")"),e+="</div>",e+="<br />",e+='<div class="description">',e+=t.description,e+="</div>",e+="<br />",e+='<div class="point-out-select-wrapper">',e+='<a href="#" data-id="'+t.id+'" data-address="'+t.address+'"',e+=' onclick="return false;" class="point-out-select button button-secondary">'+WPApiShip.__("Select"),e+="</a>",e+="</div>",e+="</div>"},getCaption:function(t){var e=t.street+", д."+t.house;return"2"==t.availableOperation&&(e+="("+WPApiShip.__("postamat")+")"),e},placePointOutToMap:function(t){e.map.geoObjects.add(new ymaps.Placemark([t.lat,t.lng],{balloonContent:e.getBalloonContent(t),iconCaption:e.getCaption(t)},{preset:"islands#icon",iconColor:"#0000ff"}))},newMap:function(t){e.map=new ymaps.Map("wpapiship-checkout-ymap",{center:[t.lat,t.lng],zoom:12,controls:[]}),e.map.controls.add(new ymaps.control.Button(WPApiShip.__("closeButtonCaption")),{float:"right"}),e.map.controls.events.add("click",(function(t){e.closeMap()}))},mapInit:function(){var t=e.getListPointsOut();null!==t&&t.rows.map((function(t){null===e.map&&e.newMap(t),e.placePointOutToMap(t)}))},getMapCenter:function(i){var a=t(e.getParam("pointOutAddressSelector")).data("lat"),n=t(e.getParam("pointOutAddressSelector")).data("lng"),o={};return o.lat=1*a,void 0!==a&&""!==a||(o.lat=i.lat),o.lng=1*n,void 0!==n&&""!==n||(o.lng=i.lng),o},mapStart:function(){var t=e.getToCity();e.listPointsOut=null;var i={action:"getListPointsOut",city:t,providerKey:e.getProviderKey(),tariffPointsList:e.getTariffPointsList(),availableOperation:"[2,3]",cod:e.getCod(),doneCallback:t=>{if(void 0!==t&&t.success){try{e.listPointsOut=JSON.parse(t.data.response.body)}catch{return void console.log("getListPointsOut:: parsing error.")}e.isMapExists()?e.getListPointsOut().rows.map((function(t,i){if(0===i){e.map.geoObjects.removeAll();var a=e.getMapCenter(t);e.map.setCenter([a.lat,a.lng])}e.placePointOutToMap(t)})):ymaps.ready(e.mapInit)}}};e.ajax(i)},ajax:function(i){return t.ajax({beforeSend:function(){"function"==typeof e.ajaxBeforeSend&&e.ajaxBeforeSend(i)},type:"POST",url:e.getAjaxUrl(),data:{action:e.getProcessAjax(),request:i},dataType:"json"}).done((function(t){"function"==typeof i.doneCallback&&i.doneCallback(t)})).fail((function(t,e){"function"==typeof i.failCallback&&i.failCallback(t,e)})).always((function(t,e){"function"==typeof i.alwaysCallback&&i.alwaysCallback(t,e)}))},openMap:function(){e.mapStart(),t("body").addClass(e.getParam("checkoutBodyOverlay")),t(e.getParam("checkoutMapWrapper")).addClass("open")},closeMap:function(){t("body").removeClass(e.getParam("checkoutBodyOverlay")),t(e.getParam("checkoutMapWrapper")).removeClass("open")},showPointOutFields:function(){t(WPApiShip.getParam("checkoutRowSelector")).removeClass("hidden"),0==t(e.getParam("checkedShippingMethodSelector")).parent().find(".wpapiship-map-start").data("point-out-id")?(t(e.getParam("pointOutFieldSelector")).val(""),t(e.getParam("pointOutAddressSelector")).val("").data("id","").data("lat","").data("lng","")):e.initSelectedPoint()},hidePointOutFields:function(){t(WPApiShip.getParam("checkoutRowSelector")).addClass("hidden"),t(e.getParam("pointOutFieldSelector")).val(""),t(e.getParam("pointOutAddressSelector")).val("").data("id","").data("lat","").data("lng","")},attachListeners:function(){t(document).on("click",e.getParam("checkoutMapSelector"),(function(t){t.stopPropagation()})),t(document).on("click",e.getParam("checkoutBodyOverlaySelector"),(function(t){e.closeMap()})),t(document).on("click",e.getParam("pointOutSelectSelector"),(function(i){t(document).trigger("selectPointOut",[t(this)]);var a,n,o=t(this).data("id"),r=!1,p="";if(void 0!==o&&(r=e.getPointOut(o))){void 0===(a=r.lat)&&(a=""),void 0===(n=r.lng)&&(n=""),p=r.city+", "+r.streetType+"."+r.street+" "+r.house,t(e.getParam("pointOutAddressSelector")).data("id",o.toString()).data("lat",a.toString()).data("lng",n.toString()),t(e.getParam("pointOutAddressSelector")).val(p),t(e.getParam("checkedShippingMethodSelector")).parent().find(".pointAddress").text(p),t(e.getParam("checkedShippingMethodSelector")).parent().find(".pointName").text(r.name),t(e.getParam("checkedShippingMethodSelector")).parent().find(".wpapiship-map-start").text(" ("+WPApiShip.__("selectedPointButtonText")+")");let i=t(e.getParam("checkedShippingMethodSelector")).parent().find(".wpapiship-map-start").data("tariff-id");var d={action:"saveClientSelectedPoint",address:p,name:r.name,id:o,tariff_id:i};e.ajax(d)}e.closeMap()})),t(document).on("click",e.getParam("shippingMethodSelector"),(function(i){t(e.getParam("pointOutFieldSelector")).val("");var a=t(e.getParam("checkedShippingMethodSelector")).val(),n=!1,o=t('.wpapiship-delivery-to-point[data-value="'+a+'"]');1==o.length&&(n=o.data("delivery-type"),e.isDeliveryToPointOut(n)?e.showPointOutFields():e.hidePointOutFields());var r={action:"saveClientSelectedTariff",tariff_id:t(this).parent().find(".wpapiship-map-start").data("tariff-id")};e.ajax(r)})),t(document).on("click",e.getParam("mapStartSelector"),(function(i){t(this).parent().find("input.shipping_method").prop("checked",!0),e.setToCity(),e.setProviderKey(),e.setTariffPointsList(),e.openMap()})),t(document).ready((function(){setInterval((function(){if(0!=t(".woocommerce .blockUI.blockOverlay").length){let i=setInterval((function(){0==t(".woocommerce .blockUI.blockOverlay").length&&(t("input.shipping_method").each((function(i){if("1"==t(this).parent().find(".wpapiship-delivery-to-point").data("tariff-selected")&&0==t(this).prop("checked"))return t(this).prop("checked",!0),void e.initSelectedPoint()})),clearInterval(i))}),1200)}}),1500)}))},initSelectedPoint:function(){var i=t(e.getParam("checkedShippingMethodSelector")).val(),a=t('.wpapiship-delivery-to-point[data-value="'+i+'"]');if(1==a.length&&"0"!=a.data("point-out-id")){var n=a.data("point-out-id"),o=a.data("point-out-address"),r={};void 0!==o&&(r.address=o),void 0!==n&&(r.id=n),t(e.getParam("pointOutFieldSelector")).val(JSON.stringify(r))}},isDeliveryToPointOut:function(i){var a=!1;return t.each(e.getParam("deliveryTypes"),(function(t,e){1*e==1*i&&"toPointOut"===t&&(a=!0)})),a},addButton:function(){setTimeout(()=>{var i='<p class="form-row form-row-wide '+WPApiShip.getParam("checkoutRow")+' hidden" id="wpapiship-point-out-address-wrapper">';i+='<label for="'+e.getParam("pointOutAddress")+'">Пункт выдачи заказа </label>',i+='<input type="text" id="'+e.getParam("pointOutAddress")+'" disabled="disabled" data-id="" data-lat="" data-lng="" />',t(i+="</p>").insertAfter(WPApiShip.getParam("pointOutFieldWrapperSelector"))},1e3)},initialSet:function(){var i=t(WPApiShip.getParam("checkedShippingMethodSelector")).val(),a=t('.wpapiship-delivery-to-point[data-value="'+i+'"]');if(1==a.length){var n=a.data("delivery-type");e.isDeliveryToPointOut(n)&&setTimeout(()=>{e.setProviderKey(),e.setTariffPointsList(),e.showPointOutFields()},2500)}},start:function(){e.canStart()&&(e.addButton(),e.initialSet(),e.attachListeners(),e.initSelectedPoint())}};WPApiShipMap=t.extend({},WPApiShipMap,e),WPApiShipMap.start()}}(jQuery);