!function(e){"use strict";if("undefined"!=typeof WPApiShipAdmin){var r={parseBool:function(e){return!/^(false|0)$/i.test(e)&&!!e},getCurrentSection:function(){return WPApiShipAdmin.data.section},isCurrentSection:function(e){return e=(e=e||!1)===r.getCurrentSection()},getCurrentTab:function(){return WPApiShipAdmin.data.tab},isCurrentTab:function(e){return e=(e=e||!1)===r.getCurrentTab()},getAjaxUrl:function(){return WPApiShipAdmin.ajaxurl},getProcessAjax:function(){return WPApiShipAdmin.process_ajax},getShippingOrderItemId:function(){var t=r.getParam("shippingOrderItemId");if(null===t){var a=e("#wpapiship-integrator-line-items");1==a.length?(r.setData("shippingOrderItemId",a.data("shipping-order-item-id")),t=r.getParam("shippingOrderItemId")):1==(a=e("#order_shipping_line_items .shipping")).length&&(r.setData("shippingOrderItemId",a.data("order_item_id")),t=r.getParam("shippingOrderItemId"))}return t},getMetaboxFields:function(){return WPApiShipAdmin.data.metaboxFields},getMetaboxField:function(e,t){return t=t||!1,(e=e||!1)?"boolean"!=typeof t||t?WPApiShipAdmin.data.metaboxFields[e][t]:WPApiShipAdmin.data.metaboxFields[e]:r.getMetaboxFields()},getParam:function(e){return null===(e=e||null)?WPApiShipAdmin.data:void 0!==WPApiShipAdmin[e]?WPApiShipAdmin[e]:void 0!==WPApiShipAdmin.data[e]?WPApiShipAdmin.data[e]:null},getShippingMethodMeta:function(e,t,a){e=e||null,t=t||null,a=a||null;var i=r.getParam("shippingMethodMeta");return null===e?i:null===t?i[e]:null===i[e][t]||void 0===i[e][t]?a:i[e][t]},__:function(e){return void 0===WPApiShipAdmin.i18n[e]?e:WPApiShipAdmin.i18n[e]},setData:function(e,r,t){t=t||"array",void 0===WPApiShipAdmin.data[e]&&"array"===t&&(WPApiShipAdmin.data[e]=[]),WPApiShipAdmin.data[e]=r},setSubmitButton:function(r,t){"connections"===r&&"hide"===t&&e(".submit").addClass("hidden"),"debug"===r&&"hide"===t&&e(".submit").addClass("hidden"),"docs"===r&&"hide"===t&&e(".submit").addClass("hidden")},getSpaces:function(e){var r="";if(void 0===e||0==e)return"";for(var t=0;t<e;t++)r+=" ";return r},orderReportLoop:0,getOrderReport:function(e){if(null===e)return"null";if("object"==typeof e){var t,a;t="[",void 0===e.push&&(t="{");var i=r.getSpaces(1)+t+"\n";return r.orderReportLoop++,Object.keys(e).forEach((function(t){"object"==typeof e[t]&&null!==e[t]?(a="]",void 0===e[t].push&&(a="}"),i=i+r.getSpaces(r.orderReportLoop)+'"'+t+'":'+r.getSpaces(" "),r.orderReportLoop++,i=(i+=r.getOrderReport(e[t]))+r.getSpaces(2*r.orderReportLoop)+a+",\n",r.orderReportLoop--):i=null===e[t]?i+r.getSpaces(2*r.orderReportLoop)+'"'+t+'":null,\n':i+r.getSpaces(2*r.orderReportLoop)+'"'+t+'":"'+e[t]+'",\n'})),r.orderReportLoop--,0==r.orderReportLoop&&(i+="}\n"),i}return"string"==typeof e?e:void 0},orderViewer:{textArea:e(".wpapiship-log-viewer pre"),box:e(".wpapiship-viewer-section"),buttonClose:e(".wpapiship-close-viewer"),inited:null,open(){return r.orderViewer.init(),r.orderViewer.box.removeClass("hidden"),this},close(){return r.orderViewer.box.addClass("hidden"),this},toggle(e){return e=e||!1,r.orderViewer.box.hasClass("hidden")?(r.orderViewer.open(),e&&r.orderViewer.add(e)):(r.orderViewer.close(),""==e&&r.orderViewer.clear()),this},add(e){return r.orderViewer.textArea.text(e),this},clear(){return r.orderViewer.textArea.text(""),this},init(){null===r.orderViewer.inited&&(r.orderViewer.buttonClose.on("click",(function(e){return r.orderViewer.clear().close(),this})),r.orderViewer.inited=!0)}},initOrderPage:function(){if("post.php"==r.getParam("pagenow")&&"shop_order"==r.getParam("post_type")){r.ajax({action:"connectionCheck",doneCallback:t=>{if(void 0!==t){try{var a=JSON.parse(t.data.response.body)}catch(e){return void console.log("connectionCheck:: Parsing error.")}t.success?(e(r.getParam("orderShippingWrapperSelector")).removeClass(r.getParam("orderHiddenClass")),setTimeout((function(){r.setPostNewOrderAction(),r.setOrderActions(),r.setStatusOrdersAction(),r.setViewOrdersAction(),r.setValidateOrdersAction(),r.setToolsOrdersAction(),r.setIntegratorOrder(),r.attachOrdersListeners()}),500)):e(r.getParam("messageContentWrapperSelector")).text(r.__("Error")+": "+a.message)}}})}},setIntegratorOrder:function(){var e=r.isCorrectIntegratorOrder();e&&r.getIntegratorOrder(e)},getIntegratorOrder:function(t){var a={action:"getIntegratorOrder",postOrderID:r.getParam("post_id"),integratorOrder:t,doneCallback:function(a){if(void 0!==a&&a.success){try{var i=JSON.parse(a.data.response.body)}catch(e){return void console.log("getSenderAddressString: Parsing error.")}if(e(r.getMetaboxField("pickupDate","selector")).val(i.order.pickupDate).attr("disabled","disabled"),e(r.getMetaboxField("contactName","selector")).val(i.sender.contactName).attr("disabled","disabled"),e(r.getMetaboxField("phone","selector")).val(i.sender.phone).attr("disabled","disabled"),e(r.getParam("pickupTypeSelector")).text(),e(r.getParam("deliveryTypeSelector")).text(),null!==i.order.pointInId&&1*i.order.pointInId>0){var o={action:"getPoint",pointId:i.order.pointInId,providerKey:i.order.providerKey,doneCallback:t=>{if(void 0!==t&&t.success){try{var a=JSON.parse(t.data.response.body)}catch(e){return void console.log("getPoint:: Parsing error.")}a.rows.length>0&&void 0!==a.rows[0]&&(e(r.getMetaboxField("pointInId","selector")).val(a.rows[0].id),e(r.getMetaboxField("pointInAddress","selector")).val(a.rows[0].address))}}};r.ajax(o)}e(document).on("click","#order_label_request",(function(){e(this).prop("disabled",!0);var a={action:"getOrderLabel",integratorOrder:t,doneCallback:r=>{if(void 0!==r&&r.success){try{var t=JSON.parse(r.data.response.body)}catch(e){return void console.log("getPoint:: Parsing error.")}"object"==typeof t.failedOrders&&null!==t.failedOrders?(e("#wpapiship-order-metabox .label-not-exists").removeClass("hidden"),e.each(t.failedOrders,(function(r,t){return e("#wpapiship-order-metabox .label-message").text(t.message),e("#order_label_request").prop("disabled",!1),!1}))):(e("#wpapiship-order-metabox .label-exists").removeClass("hidden"),e("#wpapiship-order-metabox .label-download").data("url",t.url),e("#order_label_request").addClass("hidden"))}}};r.ajax(a)}));r.ajax({action:"getSenderAddressString",order:i,doneCallback:t=>{void 0!==t&&t.success&&"string"==typeof t.data.response&&e(r.getParam("senderAddressStringSelector")).text(t.data.response)}})}}};r.ajax(a)},integratorOrderExists:function(){var e=r.getShippingMethodMeta("integratorOrder","value")||!1;return e!==r.getParam("INTEGRATOR_ORDER_INIT_VALUE")&&(1*e>0||void 0)},isCorrectIntegratorOrder:function(){var t=r.getShippingMethodMeta("integratorOrder","value")||!1;if(t===r.getParam("INTEGRATOR_ORDER_INIT_VALUE")&&(t=!1),t)return t;var a=e(r.getParam("integratorOrderWarningSelector"));if(1==a.length){var i={action:"getOrderStatusByClientNumber",postOrderID:r.getParam("post_id"),doneCallback:e=>{if(void 0!==e&&e.success){try{var t=JSON.parse(e.data.response.body)}catch(e){return}if(1*t.orderInfo.orderId>0){var i=r.__("orderExists").replace("{{id}}",r.getParam("post_id"));a.attr("title",i),a.removeClass("hidden")}}}};return r.ajax(i),!1}},setPostNewOrderAction:function(){var t=t=>{e(".button.post-orders").prop("disabled","disabled"),e("#wpapiship_viewer_preloader").removeClass("hidden"),r.orderViewer.clear()},a=r=>{e(".button.post-orders").prop("disabled",""),e("#wpapiship_viewer_preloader").addClass("hidden")},i=e=>{if(void 0!==e){try{var t=JSON.parse(e.data.response.body)}catch(e){return}e.success?(r.orderViewer.add("Новый заказ создан: #"+t.orderId),setTimeout((function(){location.reload()}),500)):r.orderViewer.add(r.getErrorsReport(t,"При создании заказа выявлены ошибки:")),r.orderViewer.open()}};e(".post-orders").on("click",(function(e){var o;e.preventDefault();var n=r.getParam("connections");0==n.length||(o=n[0].id);var d={action:"postIntegratorOrder",postOrderID:r.getParam("post_id"),shippingOrderItemId:r.getShippingOrderItemId(),providerConnectId:o,beforeCallback:t,doneCallback:i,alwaysCallback:a};d=r.getTransmittingFields(d),r.ajax(d)}))},setValidateOrdersAction:function(){var t=t=>{void 0!==t&&(r.orderViewer.clear().close(),e("#wpapiship_viewer_preloader").removeClass("hidden"))},a=t=>{if(void 0!==t){e("#wpapiship_viewer_preloader").addClass("hidden");try{var a=JSON.parse(t.data.response.body);r.setValidationReport(a)}catch(e){return console.error(e),void r.orderViewer.add("Ошибка валидации: "+e).open()}}};e(".validate-orders").on("click",(function(e){e.preventDefault();var i={action:"validateOrder",postOrderID:r.getParam("post_id"),beforeCallback:t,doneCallback:a};i=r.getTransmittingFields(i),r.ajax(i)}))},getTransmittingFields:function(t){e(r.getParam("transmittingFieldSelector")).each((function(r,a){var i=e(a),o=i.val();""==o.trim()&&void 0!==i.data("init-value")&&(o=i.data("init-value")),t[i.data("request-id")]=o}));var a=JSON.parse(r.getShippingMethodMeta("tariff","value"));return t.deliveryCost=a.deliveryCost,t},setViewOrdersAction:function(){var t=t=>{if(void 0!==t){e("#wpapiship_viewer_preloader").addClass("hidden");try{var a=JSON.parse(t.data.response.body)}catch(e){return void r.orderViewer.add("View order: "+r.__("parsingError")).open()}r.orderViewer.add("Информация по заказу:\n"+r.getOrderReport(a)).open()}};e(".view-orders").on("click",(function(a){a.preventDefault(),e("#wpapiship_viewer_preloader").removeClass("hidden");var i={action:"getIntegratorOrder"};i.postOrderID=r.getParam("post_id"),i.integratorOrder=WPApiShipAdmin.data.shippingMethodMeta.integratorOrder.value,i.doneCallback=t,r.ajax(i)}))},setStatusOrdersAction:function(){var t=t=>{if(void 0!==t){e("#wpapiship_viewer_preloader").addClass("hidden");try{var a=JSON.parse(t.data.response.body)}catch(e){return void r.orderViewer.add("Set status order: "+r.__("parsingError")).open()}r.orderViewer.add("Статус заказа:\n"+r.getOrderReport(a)).open()}};e(".status-orders").on("click",(function(a){a.preventDefault(),e("#wpapiship_viewer_preloader").removeClass("hidden");var i={action:"getOrderStatus"};i.postOrderID=r.getParam("post_id"),i.integratorOrder=WPApiShipAdmin.data.shippingMethodMeta.integratorOrder.value,i.doneCallback=t,r.ajax(i)}))},setToolsOrdersAction:function(){var t=null,a=e=>{try{var a=JSON.parse(e.data.response.body)}catch(e){return void r.orderViewer.add("Order tool: "+r.__("parsingError")).open()}var i=r.getShippingMethodMeta("integratorOrder","value",r.getParam("INTEGRATOR_ORDER_INIT_VALUE")),o="order_item_id :: "+r.getShippingOrderItemId()+"\n";o+=r.__("orderStatus")+"\n",o+="http://api.dev.apiship.ru/v1/orders/status?clientNumber="+WPApiShipAdmin.getParam("post_id")+"\n",1*i>0?(o+=r.__("orderInfo")+"\n",o+="http://api.dev.apiship.ru/v1/orders/"+i+"\n",o+=r.__("orderCancel")+"\n",o+="http://api.dev.apiship.ru/v1/orders/"+i+"/cancel\n",o+=r.__("orderDelete")+"\n",o+="http://api.dev.apiship.ru/v1/orders/"+i+"\n"):void 0!==a.orderInfo&&void 0!==a.orderInfo.orderId&&("string"==typeof t.errors.clientNumber&&(o+="\n"+t.errors.clientNumber+"\n"),o+=r.__("orderCancel")+"\n",o+="http://api.dev.apiship.ru/v1/orders/"+a.orderInfo.orderId+"/cancel\n",o+=r.__("orderDelete")+"\n",o+="http://api.dev.apiship.ru/v1/orders/"+a.orderInfo.orderId+"\n"),r.orderViewer.add("Tools:\n"+o).open()},i=function(e){void 0!==e&&e.success&&a(e)},o=e=>{if(void 0!==e){try{var o=JSON.parse(e.data.response.body)}catch(e){return void r.orderViewer.add("Validate done callback: "+r.__("parsingError")).open()}if("string"==typeof(t=r.parseResponse(o)).errors.clientNumber){var n={action:"getOrderStatusByClientNumber",postOrderID:r.getParam("post_id"),doneCallback:i};r.ajax(n)}else a(e)}};e(".tools-orders").on("click",(function(e){e.preventDefault();var t={action:"validateOrder",postOrderID:r.getParam("post_id"),doneCallback:o};r.ajax(t)}))},parseResponse:function(e){var r={errors:{}};return"object"==typeof e.errors&&e.errors.length>0&&e.errors.map((function(e){r.errors[e.field]=e.message})),r},setOrderActions:function(){r.buttonAction(".wpapiship-delete-order","deleteIntegratorOrder","удалён"),r.buttonAction(".wpapiship-cancel-order","cancelIntegratorOrder","отменён")},buttonAction:function(t,a,i="отменён"){var o=r=>{void 0!==r&&e("#wpapiship_viewer_preloader").removeClass("hidden")},n=t=>{if(void 0!==t){e("#wpapiship_viewer_preloader").addClass("hidden");var a=JSON.parse(t.data.response.body);r.orderViewer.open(),t.success?(r.orderViewer.add("Заказ #"+t.data.request.integratorOrder+" "+i),setTimeout((function(){location.reload()}),1e3)):r.orderViewer.add("При совершении действия произошла ошибка: "+a.message)}},d=t+"-confirmation",s={_self:e("#wpapiship-order-metabox "+d+".wpapiship-action-confirmation"),_noElement:e("#wpapiship-order-metabox "+d+" .confirmation-button.no"),_yesElement:e("#wpapiship-order-metabox "+d+" .confirmation-button.yes"),hiddenClass:"hidden",inited:null,open(){return r.hideAllConfirmations(),this._self.removeClass(this.hiddenClass),this},isOpened(){return!this.isClosed()},close(){return this._self.addClass(this.hiddenClass),this},isClosed(){return!!this._self.hasClass(this.hiddenClass)},toggle(){return this.isClosed()?this.open():this.close(),this},init(){return!!this.inited||1==this._self.length&&(this._noElement.on("click",(e=>{e.preventDefault(),this.close()})),this._yesElement.on("click",(e=>{e.preventDefault();var t={action:a,postOrderID:r.getParam("post_id"),integratorOrder:r.getShippingMethodMeta("integratorOrder","value"),shippingOrderItemId:r.getShippingOrderItemId(),beforeCallback:o,doneCallback:n};r.ajax(t),this.close()})),this.inited=!0,!0)}};s.init()&&e(t).on("click",(function(e){console.log(this),e.preventDefault(),s.toggle(),s.isOpened()&&setTimeout((function(){s.close()}),1e4)}))},hideAllConfirmations:function(){e("#wpapiship-order-metabox .wpapiship-action-confirmation").each((function(r,t){e(t).hasClass("hidden")||e(t).addClass("hidden")}))},setProviderData:function(){var t=r.getShippingMethodMeta("tariffProviderKey","value");if(void 0!==t){var a={action:"getConnections",doneCallback:a=>{if(void 0!==a){try{var i=JSON.parse(a.data.response.body)}catch(e){return void r.orderViewer.add("Error: "+r.__("parsingError")).open()}e(r.getParam("providerCardsSelector"));var o=r.getParam("providerCardHtml");o=(o=(o=(o=o.replace("{{providerKey}}",t)).replace("{{providerClass}}","provider-"+t)).replace("{{logoURL}}",r.getParam("providerIconURL")+t+".svg")).replace("{{classes}}",""),e(".provider-"+t+" .logo").removeClass("image-placeholder"),r.setData("providerKey",t),r.setData("connections",i.rows)}},providerKey:t};r.ajax(a)}},pointInSelectActions:function(t,a){if(t=t||!1){var i={};if("load-points"===t.target.value){i.action="getListsPoints",i.optionName=a.attr("name"),i.availableOperation="[1,3]";var o=e(".meta-value-point-in-new-address");i.doneCallback=e=>{if(void 0!==e&&e.success){var r=e.data.request;try{var t=JSON.parse(e.data.response.customHtml)}catch(e){return void console.log(r.action+": error parsing response body.")}void 0!==t&&(o.find('select[name="point-in-id-'+i.pointType+'"]').detach(),o.find(".point-in-select-wrapper."+i.pointType).append(t))}},i.providerKey=r.getParam("providerKey"),i.pointType=a.data("type"),i.optionType=a.data("type"),r.ajax(i)}else if(1*t.target.value>0){var n=t.target,d=(n.value,n.options[n.selectedIndex].text),s=t.target.value;e(r.getMetaboxField("pointInId","selector")).val(s),e(r.getMetaboxField("pointInAddress","selector")).val(d);i={action:"updatePointInData",postOrderID:r.getParam("post_id"),data:{id:s,address:d}};return void r.ajax(i)}}},attachOrdersListeners:function(){e("#wpapiship-order-metabox .label-download").on("click",(function(r){var t=e(this);t.attr("disabled","disabled"),setTimeout((()=>{t.prop("disabled",!1)}),1500),window.open(t.data("url"))})),e("#wpapiship-order-metabox .edit-data").on("click",(function(r){var t=e(this);if(t.hasClass("edit-point-in"))e(".meta-key-point-in-new-address").toggleClass("hidden"),e(".meta-value-point-in-new-address").toggleClass("hidden");else if(t.hasClass("edit-tariff")){"0"===t.attr("data-open")?t.attr("data-open","1"):t.attr("data-open","0"),e(".edit-tariff-section.meta-key").toggleClass("hidden"),e(".edit-tariff-section.meta-value").toggleClass("hidden")}else t.hasClass("edit-dimensions")?e(".wpapiship-editable-field").each((function(r,t){var a=e(t);a.hasClass("disabled")?a.removeClass("disabled").prop("disabled",!1):a.addClass("disabled").attr("disabled","disabled")})):t.hasClass("edit-price")&&(e(".edit-price-section.meta-key").toggleClass("hidden"),e(".edit-price-section.meta-value").toggleClass("hidden"))})),e("#save_price").on("click",(function(){let t=Number(e("#edit_price_input").val());var a={action:"updateDeliveryPrice",postOrderID:r.getParam("post_id"),price:t,doneCallback:function(r){void 0!==r&&(r.success?(e("#updatePriceMessage").toggleClass("hidden"),setTimeout((function(){location.reload()}),2e3)):alert("Ошибка при сохранении данных"))}};r.ajax(a)})),e("#wpapiship-order-metabox .delete-data").on("click",(function(t){var a=e(this),i=!1;if(a.hasClass("delete-point-in")?(e(r.getMetaboxField("pointInId","selector")).val(""),e(r.getMetaboxField("pointInAddress","selector")).val(""),e(".meta-key-point-in-new-address").addClass("hidden"),e(".meta-value-point-in-new-address").addClass("hidden"),i="deletePointInData"):a.hasClass("delete-point-out")&&(e(r.getMetaboxField("pointOutId","selector")).val(""),e(r.getMetaboxField("pointOutAddress","selector")).val(""),i="deletePointOutData"),i){var o={action:i,postOrderID:r.getParam("post_id")};r.ajax(o)}})),e("#wpapiship-order-metabox #wpapiship-contact-name").on("change",(function(t){var a=e(this),i={action:"saveOrderContactName",postOrderID:r.getParam("post_id"),field:{value:a.val(),id:a.attr("id")}};r.ajax(i)})),e("#wpapiship-order-metabox #wpapiship-phone").on("change",(function(t){var a=e(this),i={action:"saveOrderPhone",postOrderID:r.getParam("post_id"),field:{value:a.val(),id:a.attr("id")}};r.ajax(i)})),e("#wpapiship-order-metabox .wpapiship-editable-field").on("change",(function(t){var a=e(this),i=a.val(),o=a.data("init-value");if("number"==typeof(i*=1)){i>0||(i=o,a.val(""));var n={action:"saveOrderCustomPlaces",postOrderID:r.getParam("post_id"),field:{value:i,initValue:o,placeOrder:a.data("place-order"),dimension:a.data("dimension")}};r.ajax(n)}})),e(".wpapiship-debug").on("dblclick",(function(t){"post.php"===r.getParam("pagenow")&&(e(this).hasClass("wpapiship-open-meta")&&e(".edit").css({display:""}))})),e(".provider-card .card--key").on("dblclick",(function(t){"post.php"===r.getParam("pagenow")&&(e("#order_shipping_line_items").css({display:"contents"}),e(".field-to-control").removeClass("hidden"))})),e(document).on("change",".meta-value-point-in-new-address .point-select",(function(t){r.pointInSelectActions(t,e(this))})),e(document).on("selectPointOut",(function(t,a){var i=a.data("id"),o=a.data("address"),n=a.attr("data-tariff");console.log(n);var d="";if(void 0!==i&&(e(r.getMetaboxField("pointOutId","selector")).val(i),d="updatePointOut"),void 0!==o&&(e(r.getMetaboxField("pointOutAddress","selector")).val(o),d+="Data"),"updatePointOutData"===d){var s={action:d,postOrderID:r.getParam("post_id"),data:{id:i,address:o},tariff:n};r.ajax(s)}})),e(document).on("click","#save_admin_method",(function(t){t.preventDefault();let a=e("input[name=selected_shipping_method]:checked");if(0===a.length)return void alert("Выберите тариф");let i=e(a).data("order-id"),o=e(a).data("cost"),n=e(a).data("meta-data"),d={action:"updateAdminTariff",postOrderID:i,cost:o,method_title:e(a).data("method-title"),meta_data:n,doneCallback:function(r){void 0!==r&&(r.success?(e("#updateAdminTariffMessage").toggleClass("hidden"),console.log("SUCCESS"),console.log(r),setTimeout((function(){location.reload()}),2e3)):alert("Ошибка сохранения данных"))}};r.ajax(d)}))},initSettingsPage:function(){setTimeout((function(){r.initTabs()}),500)},initTabs:function(){r.isCurrentTab(r.getParam("pluginTab"))?(r.initPluginSections(),r.attachListeners()):r.isCurrentTab(r.getParam("shippingTab"))&&(r.initShippingSections(),r.attachListeners())},initShippingSections:function(){"apiship"==r.getParam("section")&&r.initApishipSection()},initPluginSections:function(){var e=r.getParam("section");"general"==e?r.initGeneralSection():"providers"==e?r.initProvidersSection():"docs"==e?r.initDocsSection():"debug"==e?r.initDebugSection():"calculator"==e&&r.initCalculatorSection()},initDocsSection:function(){r.setSubmitButton("docs","hide")},initApishipSection:function(){e("#wp_apiship_length, #wp_apiship_width, #wp_apiship_height, #wp_apiship_weight").on("change",(function(r){var t=e(this);t.val()<0&&t.val(0)}))},initCalculatorSection:function(){r.setSubmitButton("debug","hide")},initDebugSection:function(){r.setSubmitButton("debug","hide")},providerCard:{wrapperMessage:null,wrapperSelected:null,wrapperNotSelected:null,cardHtml:null,inited:null,add(e){return this.init(),this.append(e),this},errorMessage(e){if(e=e||!1)return this.addMessage(r.__("Error")+": "+e,"error"),this},addMessage(e,r){return r=r||"normal",this.init(),this.wrapperMessage.append('<div class="wpapiship-notice notice-'+r+'">'+e+"</div>"),this.wrapperMessage.removeClass("hidden"),this.wrapperMessage.parents("tr").removeClass("hidden").css({display:""}),this},append(e){return e.selected?(this.wrapperSelected.append(this._getNewCard(e)),this._setSelectedCardData(e)):this.wrapperNotSelected.append(this._getNewCard(e)),this._setCardFooter(e),this._removePlaceholder(e),this},_getNewCard(t){var a=t.selected?" "+r.getParam("selectedProviderCardClass"):"",i=this.cardHtml;i=(i=i.replace("{{providerKey}}",t.key)).replace("{{providerClass}}","provider-"+t.key+a);var o=this._getLogoURL(t.key);i=i.replace("{{logoURL}}",o),i=this.noImageProviders.includes(t.key)?i.replace("{{classes}}","no-image"):i.replace("{{classes}}",""),i=t.selected?(i=i.replace("{{selected-hidden}}","")).replace("{{not-selected-hidden}}","hidden"):(i=i.replace("{{selected-hidden}}","hidden")).replace("{{not-selected-hidden}}","");let n=t.data.pickup_types,d="",s="";return-1!=e.inArray("1",n)&&(d="checked"),-1!=e.inArray("2",n)&&(s="checked"),i=(i=i.replace("{{pickuptype1}}",d)).replace("{{pickuptype2}}",s)},_setCardFooter(t){e(".provider-"+t.key+" .card--name").text(r.getParam("nameTitle")+": "+t.name),t.selected&&e(".provider-"+t.key+" .card--point-in-id").removeClass("hidden"),-1!=e.inArray("2",t.data.pickup_types)&&e(".provider-"+t.key+" .pickup-point").removeClass("hidden")},_removePlaceholder(r){e(".provider-"+r.key+" .logo").removeClass("image-placeholder")},_getLogoURL(e){var t=r.getParam("providerIconURL")+e+".svg";return this.noImageProviders.includes(e)&&(t=r.getParam("imageURL")+r.getParam("providerPlaceholder")),t},_setCardData(t){if(!t.hasClass(r.getParam("providerCardProcessedClass"))){var a=t.data("provider-key");if(void 0!==a||""!==a){var i={action:"getTariffs",providerKey:a,doneCallback:e=>{if(void 0!==e&&e.success)try{r.orderViewer.add("getTariffs callback: "+r.__("parsingError")).open()}catch(e){return void r.orderViewer.add("getTariffs callback: "+r.__("parsingError")).open()}}};r.ajax(i);var o={action:"getProviderConnections",providerKey:a,doneCallback:e=>{if(void 0!==e&&e.success)try{r.orderViewer.add("getProviderConnections callback: "+r.__("parsingError")).open()}catch(e){return void r.orderViewer.add("getProviderConnections callback: "+r.__("parsingError")).open()}}};r.ajax(o);var n={action:"getCardSelectHtml",providerKey:a,doneCallback:a=>{void 0!==a&&a.success&&e.each(r.getParam("ownerPointTypes"),(function(e,i){a.data.response[i].html&&(t.find('select[name="point-in-id-'+i+'"]').detach(),t.find(r.getParam("pointInSelectWrapperSelector")+"."+i).append(a.data.response[i].html))}))}};r.ajax(n),t.addClass(r.getParam("providerCardProcessedClass"))}}},_setSelectedCardData(t){r.providerCard._setCardData(e(r.getParam("providerCardSelector")+".provider-"+t.key))},_isCardSelected:e=>!!e.hasClass(r.getParam("selectedProviderCardClass")),_selectActions(e,r){(e=e||!1)&&("load-points"===e.target.value?this._getListsPoints(e,r):"reset-point"===e.target.value?this._resetSelectedPointIn(e,r):1*e.target.value>0&&this._saveSelectedPointIn(e,r))},_resetSelectedPointIn(e,t){var a=t.parents(r.getParam("providerCardSelector")),i={action:"deleteSelectedPointIn",providerKey:a.data("provider-key"),pointType:t.data("type"),doneCallback:e=>{if(void 0!==e&&e.success){var t=e.data.request;try{var i=JSON.parse(e.data.response[t.pointType].html)}catch(e){return void r.providerCard.errorMessage("resetSelectedPoint Parsing success response body.")}void 0!==i&&(a.find('select[name="point-in-id-'+t.pointType+'"]').detach(),a.find(r.getParam("pointInSelectWrapperSelector")+"."+t.pointType).append(i))}}};r.ajax(i)},_saveSelectedPointIn(e,t){var a=t.parents(r.getParam("providerCardSelector")),i=e.target,o=i.value,n=i.options[i.selectedIndex].text,d={action:"saveSelectedPointIn",providerKey:a.data("provider-key"),pointId:o,pointAddress:n,pointType:t.data("type")};r.ajax(d)},_getListsPoints(e,t){var a=t.parents(r.getParam("providerCardSelector")),i={action:"getListsPoints",providerKey:a.data("provider-key"),optionName:t.attr("name"),optionType:t.data("type"),availableOperation:"[1,3]",doneCallback:e=>{if(void 0!==e&&e.success){try{var t=JSON.parse(e.data.response.customHtml)}catch(e){return void r.providerCard.errorMessage("getListsPoints: Parsing success response body.")}var i=e.data.request;void 0!==t&&(a.find('select[name="point-in-id-'+i.optionType+'"]').detach(),a.find(r.getParam("pointInSelectWrapperSelector")+"."+i.optionType).append(t))}}};r.ajax(i)},_selectPickup(t){if(t=t||!1){var a=t.parents(r.getParam("providerCardSelector")),i=[];e(a).find(".provider-card-pickup-select").each((function(r,t){var o=e(t).val();!0===e(t).prop("checked")?(i.push(o),"2"==o&&e(a).find(".pickup-point").removeClass("hidden")):"2"==o&&e(a).find(".pickup-point").addClass("hidden")}));var o={action:"saveSelectedPickupTypes",selectedTypes:i,providerKey:a.data("provider-key"),doneCallback:e=>{void 0!==e&&console.log("success")}};r.ajax(o)}},init(){null===this.inited&&(this.wrapperMessage=e(r.getParam("providerMessageSelector")),this.wrapperSelected=e(r.getParam("selectedProviderCardsSelector")),this.wrapperNotSelected=e(r.getParam("notSelectedProviderCardsSelector")),this.cardHtml=r.getParam("providerCardHtml"),this.noImageProviders=r.getParam("noImageProviders"),this.imageURL=r.getParam("imageURL"),this.providerPlaceholder=r.getParam("providerPlaceholder"),setTimeout((function(){e(r.getParam("providerCardSelector")).on("click",(function(t){r.providerCard._setCardData(e(this))})),e(r.getParam("providerCardPickupSelect")).on("change",(function(t){r.providerCard._selectPickup(e(this))})),e(document).on("change",".provider-card .point-select",(function(t){r.providerCard._selectActions(t,e(this))}))}),1e3),this.inited=!0)}},initProvidersSection:function(){r.setSubmitButton("connections","hide"),e.when().then((function(){return r.ajax({action:"getProviders"})}),(function(){})).then((function(t){if(t.success){try{var a=JSON.parse(t.data.response.body)}catch(e){return void r.providerCard.errorMessage("Parsing success response body.")}e(r.getParam("providersFormSelector")).removeClass("hidden"),a.rows.map((function(e){r.providerCard.add(e)}))}else try{a=JSON.parse(t.data.response.body);r.providerCard.errorMessage(a.message)}catch(e){r.providerCard.errorMessage("Parsing error response body.")}}))},initGeneralSection:function(){e(".options-field-disabled").prop("disabled","disabled"),e(".wp-apiship-remove-self").remove(),e("#wp_apiship_length, #wp_apiship_width, #wp_apiship_height, #wp_apiship_weight").on("change",(function(r){var t=e(this);t.val()<0&&t.val(0)})),e(document).ready((function(){if(0!==e(".wp-apiship-mapping-container").length){let r=function(){e(".wp-apiship-mapping-row").each((function(r){let t=e(this).find(".wp-apiship-status-active").prop("checked");e(this).find(".wp-apiship-mapping-config-col").each((function(r){!0===t?e(this).removeClass("wp-apiship-mapping-config-disabled"):e(this).addClass("wp-apiship-mapping-config-disabled")}))}))};e(".wp-apiship-status-active").on("change",(function(){r()})),r()}}))},ajaxBeforeSend:function(e){"function"==typeof e.beforeCallback&&e.beforeCallback(e)},ajax:function(t){return e.ajax({beforeSend:function(){"function"==typeof r.ajaxBeforeSend&&r.ajaxBeforeSend(t)},type:"POST",url:r.getAjaxUrl(),data:{action:r.getProcessAjax(),request:t},dataType:"json"}).done((function(e){"function"==typeof t.doneCallback&&t.doneCallback(e)})).fail((function(e,r){"function"==typeof t.failCallback&&t.failCallback(e,r)})).always((function(e,r){"function"==typeof t.alwaysCallback&&t.alwaysCallback(e,r)}))},attachListeners:function(){e("#get-providers").on("click",(function(e){r.getProviders()}))},getCalculation:function(){var t={action:"getCalculation",doneCallback:r=>{if(void 0!==r&&r.success){try{var t=JSON.parse(r.data.response.body)}catch(r){return void e("#calculate-response").val("Incorrect response")}var a="";void 0!==t.deliveryToDoor&&(a+="deliveryToDoor: \n",t.deliveryToDoor.map((function(e){a+=e.providerKey+" - "+e.tariffs.length+" tariffs\n"}))),a+="------\n",void 0!==t.deliveryToPoint&&(a+="deliveryToPoint: \n",t.deliveryToPoint.map((function(e){a+=e.providerKey+" - "+e.tariffs.length+" tariffs\n"}))),e("#calculate-response").val(a)}},beforeCallback:()=>{e("#calculate-response").val("")}};r.ajax(t)},setValidationReport:function(e,t="Проверка пройдена успешно"){let a=t;void 0!==e.errors&&e.errors.length>0&&(a=r.getErrorsReport(e)),r.orderViewer.add(a).open()},getErrorsReport:function(e,r="При проверке выявлены следующие ошибки:"){return e.errors?(r+="\n\n",e.errors.forEach((function(e,t,a){r=r+"Поле "+e.field+" - "+e.message+"\n"})),r):void 0!==e.message?r+"\n"+e.message+"\n"+e.description:r+"\nНеизвестная ошибка"},getProviders:function(){var t={action:"getProviders",data:"Some data",doneCallback:r=>{if(void 0!==r){var t=JSON.parse(r.data.response.body),a="";e.each(t.rows,(function(e,r){a=a+r.name+" | "+r.key,null!==r.description&&(a=a+" | "+r.description),a+="\n"})),e("#providers").val(a)}}};r.ajax(t)},start:function(){r.initSettingsPage(),r.initOrderPage()}};WPApiShipAdmin=e.extend({},WPApiShipAdmin,r),WPApiShipAdmin.start()}}(jQuery);