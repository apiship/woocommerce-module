!function(t){"use strict";if("undefined"!=typeof WPApiShipAdmin&&"undefined"!=typeof WPApiShipAdminMap){var i={parseBool:function(t){return!/^(false|0)$/i.test(t)&&!!t},listPointsOut:null,map:null,tariffList:null,pointsMode:2,toCity:null,providerKey:null,requestKeyEnabled:!1,existsYmaps:function(){return"undefined"!=typeof ymaps},isMapExists:function(){return null!==i.map&&"object"==typeof i.map},getBalloonContent:function(t){var e='<div class="point-out-balloon-content">';e+='<div class="provider-key">Служба доставки: '+t.providerName,e+="</div>",e+='<div class="point-out-address">'+t.streetType+"."+t.street+", д."+t.house,"2"==t.availableOperation&&(e+=" ("+WPApiShipAdmin.__("postamat")+")"),e+="</div>",e+="<br />",e+='<div style="margin-bottom: 10px;">',e+="<div>Выбор тарифа</div>",e+='<select class="wpapiship-select-map-tariff">';let a=null;return i.tariffList.forEach((i=>{let n=i.daysMin,o=!1;if(i.pointIds.forEach((i=>{i==t.id&&(o=!0)})),!1===o)return;i.daysMin!=i.daysMax&&(n+="-"+i.daysMax);let s=JSON.stringify(i);s=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),null===a&&(a=s),e+='<option data-method-id="'+i.methodId+'" data-provider-key="'+i.providerKey+'" value="'+i.tariffId+'" data-tariff="'+s+'">',e+=i.providerName+", ",e+=i.tariffName+", ",e+=n+" дн., ",e+=i.deliveryCost?.toFixed(2)+" руб.",e+="</option>"})),e+="</select>",e+="</div>",e+='<div class="description">',e+=t.description,e+="</div>",e+="<br />",e+='<div class="point-out-select-wrapper">',e+='<a href="#" data-tariff="'+a+'" data-id="'+t.id+'" data-address="'+t.address+'" onclick="return false;" class="point-out-select button button-secondary">'+WPApiShipAdmin.__("Select")+"</a>",e+="</div>",e+="</div>"},getCaption:function(t){var i=t.street+", д."+t.house;return"2"==t.availableOperation&&(i+="(постамат)"),i},placePointOutToMap:function(e){i.map.geoObjects.add(new ymaps.Placemark([e.lat,e.lng],{balloonContent:i.getBalloonContent(e)},{preset:"islands#icon",iconColor:"#0000ff"})),t(document).on("change",".wpapiship-select-map-tariff",(function(i){t(".point-out-select").attr("data-tariff",t(this).find("option:selected").attr("data-tariff"))}))},newMap:function(){i.map=new ymaps.Map("wpapiship-ymap",{center:[55.753909,37.620938],zoom:12,controls:[]}),i.map.controls.add(new ymaps.control.ZoomControl({options:{size:"small"}}))},mapInit:function(){if(null!==i.listPointsOut){var t=WPApiShipAdmin.getParam("currentPointOutData"),e=!1,a=null;i.listPointsOut.rows.map((function(n,o){null===a&&n.countryCode==WPApiShipAdmin.getParam("wcCountryCode")&&(a=n),(a=>{i.parseBool(t)&&t.id===a.id&&(e=a)})(n),null===i.map&&i.newMap(),i.placePointOutToMap(n)})),e?i.map.setCenter([e.lat,e.lng]):null!==a&&i.map.setCenter([a.lat,a.lng])}},startMap:function(){i.tariffList=JSON.parse(t("#adminTariffList").html()),i.tariffPointsList=JSON.parse(t("#adminTariff").html()).pointIds;var e=WPApiShipAdmin.getParam("wcShipping");console.log(i.getTariffPointsList());var a={action:"getListPointsOut",city:e._shipping_city,tariffPointsList:i.getTariffPointsList(),availableOperation:"[2,3]",cod:i.getCod(),doneCallback:t=>{if(void 0!==t&&t.success){try{i.listPointsOut=JSON.parse(t.data.response.body)}catch(t){return void console.log("getListPointsOut:: parsing error.")}ymaps.ready(i.mapInit)}}};a.providerKey=WPApiShipAdmin.getShippingMethodMeta("tariffProviderKey","value"),WPApiShipAdmin.ajax(a)},getCod:function(){return"cod"==i.getPaymentMethod()?"1":"0"},getPaymentMethod:function(){return console.log(t("#_payment_method").val()),t("#_payment_method").val()},getTariffPointsList:function(){return i.tariffPointsList},warning:function(){t(WPApiShipAdmin.getParam("ymapSelector")).text("").text(WPApiShipAdmin.__("notYMap")).addClass("not-ymap").toggleClass("hidden")},attachListeners:function(){t(document).on("click",".point-out-select",(function(i){t(document).trigger("selectPointOut",[t(this)]),t(WPApiShipAdmin.getParam("ymapSelector")).toggleClass("hidden"),t("#pointOutSaveMessage").toggleClass("hidden"),setTimeout((function(){location.reload()}),2e3)})),t("#wpapiship-order-metabox .edit-data").on("click",(function(e){if(t(this).hasClass("edit-point-out")){if(!i.existsYmaps())return void i.warning();i.isMapExists()||i.startMap(),t(WPApiShipAdmin.getParam("ymapSelector")).toggleClass("hidden")}}))},start:function(){"post.php"==WPApiShipAdmin.getParam("pagenow")&&"shop_order"==WPApiShipAdmin.getParam("post_type")&&i.attachListeners()}};WPApiShipAdminMap=t.extend({},WPApiShipAdminMap,i),WPApiShipAdminMap.start()}}(jQuery);